cd:
  name: CD - Deploy Infra and DAGs
  needs: ci
  if: github.ref == 'refs/heads/main'
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v3

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.4.6

    - name: Terraform Apply
      run: |
        cd terraform
        terraform apply -auto-approve
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GCP_CREDS }}

    - name: Deploy DAGs to Composer
      run: |
        gsutil -m cp -r dags gs://<your-bucket>/dags/
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GCP_CREDS }}

    - name: Deploy plugins to Composer
      run: |
        gsutil -m cp -r plugins gs://<your-bucket>/plugins/
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GCP_CREDS }}

    - name: Deploy data to Composer
      run: |
        gsutil -m cp -r data gs://<your-bucket>/data/
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GCP_CREDS }}
